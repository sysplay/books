<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>USB Drivers in Linux | Introduction</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.6">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../Content/Part12.html" />
    
    
    <link rel="prev" href="../Content/Part10.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="11"
        data-chapter-title="USB Drivers in Linux"
        data-filepath="Content/Part11.md"
        data-basepath=".."
        data-revision="Thu Oct 27 2016 14:08:48 GMT+0300 (AST)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Preface
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="Content/Part01.html">
            
                
                    <a href="../Content/Part01.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Linux Device Drivers for Your Girl Friend
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="Content/Part02.html">
            
                
                    <a href="../Content/Part02.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Writing Your First Linux Driver in the Classroom
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="Content/Part03.html">
            
                
                    <a href="../Content/Part03.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Kernel C Extras in a Linux Driver
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="4" data-path="Content/Part04.html">
            
                
                    <a href="../Content/Part04.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Linux Character Drivers
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="Content/Part05.html">
            
                
                    <a href="../Content/Part05.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Character Device Files - Creation &amp; Operations
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="Content/Part06.html">
            
                
                    <a href="../Content/Part06.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        Decoding Character Device File Operations
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="Content/Part07.html">
            
                
                    <a href="../Content/Part07.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        Generic Hardware Access in Linux
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="Content/Part08.html">
            
                
                    <a href="../Content/Part08.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        Accessing x86-Specific I/O-Mapped Hardware
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="Content/Part09.html">
            
                
                    <a href="../Content/Part09.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                        I/O Control in Linux
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="10" data-path="Content/Part10.html">
            
                
                    <a href="../Content/Part10.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                        Kernel-Space Debuggers in Linux
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="11" data-path="Content/Part11.html">
            
                
                    <a href="../Content/Part11.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                        USB Drivers in Linux
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="12" data-path="Content/Part12.html">
            
                
                    <a href="../Content/Part12.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                        USB Drivers in Linux Continued
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="13" data-path="Content/Part13.html">
            
                
                    <a href="../Content/Part13.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                        Data Transfer to and from USB Devices
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="14" data-path="Content/Part14.html">
            
                
                    <a href="../Content/Part14.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                        A Dive Inside the Hard Disk for Understanding Partitions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="15" data-path="Content/Part15.html">
            
                
                    <a href="../Content/Part15.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                        Disk on RAM: Playing with Block Drivers
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="16" data-path="Content/Part16.html">
            
                
                    <a href="../Content/Part16.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                        Kernel Window - Peeping through /proc
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="17" data-path="Content/Part17.html">
            
                
                    <a href="../Content/Part17.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                        Module Interactions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="18" data-path="Content/Part18.html">
            
                
                    <a href="../Content/Part18.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>18.</b>
                        
                        File Systems - A Semester Project
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="19" data-path="Content/Part19.html">
            
                
                    <a href="../Content/Part19.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>19.</b>
                        
                        File Systems: A Semester Project - II
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="20" data-path="Content/Part20.html">
            
                
                    <a href="../Content/Part20.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>20.</b>
                        
                        The Semester Project: File Systems - III
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="21" data-path="Content/Part21.html">
            
                
                    <a href="../Content/Part21.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>21.</b>
                        
                        The Semester Project - IV: FS Formatting a Pen Drive
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="22" data-path="Content/Part22.html">
            
                
                    <a href="../Content/Part22.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>22.</b>
                        
                        The Semester Project - V: The File System Module Template
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="23" data-path="Content/Part23.html">
            
                
                    <a href="../Content/Part23.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>23.</b>
                        
                        The Semester Project - VI: File System on Block Device
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="24" data-path="Content/Part24.html">
            
                
                    <a href="../Content/Part24.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>24.</b>
                        
                        The Semester Project - VII: The File System in Action
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Introduction</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="usb-drivers-in-linux">USB Drivers in Linux</h1>
<blockquote>
<p>This eleventh article, which is part of the series on Linux device drivers, gets you started with writing your first USB driver in Linux.</p>
</blockquote>
<p>Pugs&#x2019; pen drive was the device, Shweta was playing with, when both of them sat down to explore the world of USB drivers in Linux. The fastest way to get hang of one, the usual Pugs&#x2019; way, was to pick up a USB device and write a driver for it to experiment with. So, they chose pen drive aka USB stick, available at hand. It was JetFlash from Transcend with vendor ID 0x058f and product ID 0x6387.</p>
<h2 id="usb-device-detection-in-linux">USB device detection in Linux</h2>
<p>Whether a driver of a USB device is there or not on a Linux system, a valid USB device would always get detected at the hardware and kernel spaces of a USB-enabled Linux system. A valid USB device is a device designed and detected as per USB protocol specifications. Hardware space detection is done by the USB host controller &#x2013; typically a native bus device, e.g. a PCI device on x86 systems. The corresponding host controller driver would pick and translate the low-level physical layer information into higher level USB protocol specific information. The USB protocol formatted information about the USB device is then populated into the generic USB core layer (usbcore driver) in the kernel space, thus enabling the detection of a USB device in the kernel space, even without having its specific driver.</p>
<p>After this, it is up to the various drivers, interfaces, and applications (which are dependent on the various Linux distributions), to have the user space view of the detected devices. Figure 17 shows a top to bottom view of USB subsystem in Linux. A basic listing of all detected USB devices can be obtained using the lsusb command, as root. Figure 18 shows the same, without and with the pen drive being inserted into the system. A -v option to lsusb provides detailed information. In many Linux distributions like Mandriva, Fedora, &#x2026; <code>usbfs</code> driver is loaded as part of the default configuration. This enables the detected USB device details to be viewed in a more techno-friendly way through the <code>/proc</code> window using <code>cat /proc/bus/usb/devices</code>. Figure 19 shows a typical snippet of the same, clipped around the pen drive specific section. The complete listing basically contains such sections, each for one of the valid USB devices detected on the Linux system.</p>
<p><img src="../Images/Part11/figure_17_usb_subsystem_in_linux.png" alt="Figure 17"></p>
<p><img src="../Images/Part11/figure_18_lsusb_output.png" alt="Figure 18"></p>
<p><img src="../Images/Part11/figure_19_usb_proc_window_snippet.png" alt="Figure 19"></p>
<h2 id="decoding-a-usb-device-section">Decoding a USB device section</h2>
<p>To further decode these sections, a valid USB device needs to be understood first. All valid USB devices contain one or more configurations. A configuration of a USB device is like a profile, where the default one is the commonly used one. As such, Linux supports only one configuration per device &#x2013; the default one. For every configuration, the device may have one or more interfaces. An interface corresponds to the functionality provided by the device. There would be as many interfaces as the number of independent functionalities provided by the device. So, say an MFD (multi-function device) USB printer can do printing, scanning, and faxing, then it most likely would have at least three interfaces &#x2013; one for each of the functionalities. So, unlike other device drivers, a USB device driver is typically associated/written per interface, rather than the device as a whole &#x2013; meaning one USB device may have multiple device drivers. Though definitely one interface can have a maximum of one driver only.</p>
<p>Moreover, it is okay and common to have a single USB device driver for all the interfaces of a USB device. The &#x201C;Driver=&#x2026;&#x201D; entry in the proc window output (Figure 19) shows the interface is to driver mapping &#x2013; a &#x201C;(none)&#x201D; indicating no associated driver. For every interface, there would be one or more end points. An endpoint is like a pipe for transferring information either into or from the interface of the device, depending on the functionality. Depending on the type of information, the endpoints have four types:</p>
<ul>
<li>Control</li>
<li>Interrupt</li>
<li>Bulk</li>
<li>Isochronous</li>
</ul>
<p>As per USB protocol specification, all valid USB devices have an implicit special control endpoint zero, the only bi-directional endpoint. Figure 20 shows the complete pictorial representation of a valid USB device, based on the above explanation.</p>
<p>Coming back to the USB device sections (Figure 19), the first letter on each line represents the various parts of the USB device specification just explained. For example, D for device, C for configuration, I for interface, E for endpoint, etc. Details about them and various others are available under the kernel source <code>Documentation/usb/proc_usb_info.txt</code></p>
<p><img src="../Images/Part11/figure_20_usb_device_overview.png" alt="Figure 20"></p>
<h2 id="the-usb-pen-drive-driver-registration">The USB pen drive driver registration</h2>
<p>&#x201C;Seems like there are so many things to know about the USB protocol to be able to write the first USB driver itself &#x2013; device configuration, interfaces, transfer pipes, their four types, and so many other symbols like T, B, S, &#x2026; under a USB device specification&#x201D;, sighed Shweta. &#x201C;Yes, but don&#x2019;t you worry &#x2013; all these can be talked in detail, later. Let&#x2019;s do the first thing first &#x2013; get our pen drive&#x2019;s interface associated with our USB device driver (<code>pen_register.ko</code>)&#x201D;, consoled Pugs. Like any other Linux device driver, here also we need the constructor and the destructor &#x2013; basically the same driver template that has been used for all the drivers. Though the content would vary as this is a hardware protocol layer driver, i.e. a horizontal driver unlike a character driver, which was one of the vertical drivers, discussed so far. And the difference would be that instead of registering with &amp; unregistering from VFS, here we would do that with the corresponding protocol layer &#x2013; the USB core in this case; instead of providing a user space interface like a device file, it would get connected with the actual device in the hardware space. The USB core APIs for the same are as follows (prototyped in <code>&lt;linux/usb.h&gt;</code>):</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">usb_register</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_driver *driver)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">usb_deregister</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_driver *)</span></span>;
</code></pre>
<p>As part of the usb_driver structure, the fields to be provided are the driver&#x2019;s name, ID table for auto-detecting the particular device and the 2 callback functions to be invoked by USB core during hot-plugging and hot-removal of the device, respectively. Putting it all together, <code>pen_register.c</code> would look like:</p>
<pre><code class="lang-C"><span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/usb.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">pen_probe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_interface *interface, <span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> usb_device_id *id)</span>
</span>{
    printk(KERN_INFO <span class="hljs-string">&quot;Pen drive (%04X:%04X) plugged\n&quot;</span>, id-&gt;idVendor,
                                id-&gt;idProduct);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pen_disconnect</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_interface *interface)</span>
</span>{
    printk(KERN_INFO <span class="hljs-string">&quot;Pen drive removed\n&quot;</span>);
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> usb_device_id pen_table[] =
{
    { USB_DEVICE(<span class="hljs-number">0x058F</span>, <span class="hljs-number">0x6387</span>) },
    {} <span class="hljs-comment">/* Terminating entry */</span>
};
MODULE_DEVICE_TABLE (usb, pen_table);

<span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> usb_driver pen_driver =
{
    .name = <span class="hljs-string">&quot;pen_driver&quot;</span>,
    .id_table = pen_table,
    .probe = pen_probe,
    .disconnect = pen_disconnect,
};

<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> __<span class="hljs-function">init <span class="hljs-title">pen_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-keyword">return</span> usb_register(&amp;pen_driver);
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __<span class="hljs-function"><span class="hljs-built_in">exit</span> <span class="hljs-title">pen_exit</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    usb_deregister(&amp;pen_driver);
}

module_init(pen_init);
module_exit(pen_exit);

MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);
MODULE_AUTHOR(<span class="hljs-string">&quot;Anil Kumar Pugalia &lt;email@sarika-pugs.com&gt;&quot;</span>);
MODULE_DESCRIPTION(<span class="hljs-string">&quot;USB Pen Registration Driver&quot;</span>);
</code></pre>
<p>Then, the usual steps for any Linux device driver may be repeated:</p>
<ul>
<li>Build the driver (.ko file) by running <code>make</code></li>
<li>Load the driver using <code>insmod</code></li>
<li>List the loaded modules using <code>lsmod</code></li>
<li>Unload the driver using <code>rmmod</code></li>
</ul>
<p>But surprisingly the results wouldn&#x2019;t be as expected. Check for dmesg and the proc window to see the various logs and details. Not because USB driver is different from a character driver. But there&#x2019;s a catch. Figure 19 shows that the pen drive has one interface (numbered 0), which is already associated with the usual usb-storage driver. Now, in order to get our driver associated with that interface, we need to unload the usb-storage driver (i.e. rmmod usb-storage) after plugging in the pen drive, and then load our driver. Once this sequence is followed, the results would be as expected. Figure 21 shows a glimpse of the possible logs and proc window snippet. Repeat hot-plugging in and hot-plugging out the pen drive to observe the probe and disconnect calls in action &#x2013; but don&#x2019;t forget unloading the usb-storage driver, every time you plug in the pen driver.</p>
<p><img src="../Images/Part11/figure_21_pen_driver.png" alt="Figure 21"></p>
<h2 id="summing-up">Summing up</h2>
<p>&#x201C;Finally!!! Something into action.&#x201D;, relieved Shweta. &#x201C;But seems like there are so many things around (like the device ID table, probe, disconnect, &#x2026;), yet to be assimilated and understood to get a complete USB device driver, in place&#x201D;, she continued. &#x201C;Yes, you are right. Let&#x2019;s take them one by one, with breaks&#x201D;, replied Pugs taking a stretching break.</p>
<h2 id="notes">Notes</h2>
<ol>
<li>Make sure that you replace the vendor id &amp; device id in the above code examples by the ones of your pen drive.</li>
<li>One may wonder, as how does the usb-storage get autoloaded. The answer lies in the module autoload rules written down in the file <code>/lib/modules/&lt;kernel_version&gt;/modules.usbmap</code>. If you are an expert, you may comment out the corresponding line, for it to not get autoloaded. And uncomment it back, once you are done with your experiments.</li>
<li>In latest distros, you may not find the detailed description of the USB devices using <code>cat /proc/bus/usb/devices</code>, as the <code>/proc/bus/usb/</code> itself has been deprecated. You can find the same detailed info using <code>cat /sys/kernel/debug/usb/devices</code> &#x2013; though you may need <code>root</code> permissions for the same. Also, if you do not see any file under <code>/sys/kernel/debug</code> (even as root), then you may have to first mount the debug filesystem, as follows: <code>mount -t debugfs none /sys/kernel/debug</code></li>
</ol>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../Content/Part10.html" class="navigation navigation-prev " aria-label="Previous page: Kernel-Space Debuggers in Linux"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../Content/Part12.html" class="navigation navigation-next " aria-label="Next page: USB Drivers in Linux Continued"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
