<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Linux Character Drivers | Introduction</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.6">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../Content/Part05.html" />
    
    
    <link rel="prev" href="../Content/Part03.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="4"
        data-chapter-title="Linux Character Drivers"
        data-filepath="Content/Part04.md"
        data-basepath=".."
        data-revision="Thu Oct 27 2016 14:08:48 GMT+0300 (AST)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Preface
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="Content/Part01.html">
            
                
                    <a href="../Content/Part01.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Linux Device Drivers for Your Friend
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2" data-path="Content/Part02.html">
            
                
                    <a href="../Content/Part02.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Writing Your First Linux Driver in the Classroom
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3" data-path="Content/Part03.html">
            
                
                    <a href="../Content/Part03.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Kernel C Extras in a Linux Driver
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="4" data-path="Content/Part04.html">
            
                
                    <a href="../Content/Part04.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Linux Character Drivers
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="5" data-path="Content/Part05.html">
            
                
                    <a href="../Content/Part05.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                        Character Device Files - Creation &amp; Operations
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="6" data-path="Content/Part06.html">
            
                
                    <a href="../Content/Part06.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                        Decoding Character Device File Operations
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="7" data-path="Content/Part07.html">
            
                
                    <a href="../Content/Part07.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                        Generic Hardware Access in Linux
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="8" data-path="Content/Part08.html">
            
                
                    <a href="../Content/Part08.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>8.</b>
                        
                        Accessing x86-Specific I/O-Mapped Hardware
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="9" data-path="Content/Part09.html">
            
                
                    <a href="../Content/Part09.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>9.</b>
                        
                        I/O Control in Linux
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="10" data-path="Content/Part10.html">
            
                
                    <a href="../Content/Part10.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>10.</b>
                        
                        Kernel-Space Debuggers in Linux
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="11" data-path="Content/Part11.html">
            
                
                    <a href="../Content/Part11.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>11.</b>
                        
                        USB Drivers in Linux
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="12" data-path="Content/Part12.html">
            
                
                    <a href="../Content/Part12.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>12.</b>
                        
                        USB Drivers in Linux Continued
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="13" data-path="Content/Part13.html">
            
                
                    <a href="../Content/Part13.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>13.</b>
                        
                        Data Transfer to and from USB Devices
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="14" data-path="Content/Part14.html">
            
                
                    <a href="../Content/Part14.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>14.</b>
                        
                        A Dive Inside the Hard Disk for Understanding Partitions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="15" data-path="Content/Part15.html">
            
                
                    <a href="../Content/Part15.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>15.</b>
                        
                        Disk on RAM: Playing with Block Drivers
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="16" data-path="Content/Part16.html">
            
                
                    <a href="../Content/Part16.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>16.</b>
                        
                        Kernel Window - Peeping through /proc
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="17" data-path="Content/Part17.html">
            
                
                    <a href="../Content/Part17.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>17.</b>
                        
                        Module Interactions
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="18" data-path="Content/Part18.html">
            
                
                    <a href="../Content/Part18.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>18.</b>
                        
                        File Systems - A Semester Project
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="19" data-path="Content/Part19.html">
            
                
                    <a href="../Content/Part19.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>19.</b>
                        
                        File Systems: A Semester Project - II
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="20" data-path="Content/Part20.html">
            
                
                    <a href="../Content/Part20.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>20.</b>
                        
                        The Semester Project: File Systems - III
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="21" data-path="Content/Part21.html">
            
                
                    <a href="../Content/Part21.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>21.</b>
                        
                        The Semester Project - IV: FS Formatting a Pen Drive
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="22" data-path="Content/Part22.html">
            
                
                    <a href="../Content/Part22.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>22.</b>
                        
                        The Semester Project - V: The File System Module Template
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="23" data-path="Content/Part23.html">
            
                
                    <a href="../Content/Part23.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>23.</b>
                        
                        The Semester Project - VI: File System on Block Device
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="24" data-path="Content/Part24.html">
            
                
                    <a href="../Content/Part24.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>24.</b>
                        
                        The Semester Project - VII: The File System in Action
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Introduction</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="device-drivers-part-4-linux-character-drivers">Device Drivers, Part 4: Linux Character Drivers</h1>
<blockquote>
<p>This article, which is part of the series on Linux device drivers, deals with the various concepts related to character drivers and their implementation.</p>
</blockquote>
<p>Shweta, at her PC in her hostel room, was all set to explore the characters of Linux character drivers, before it was taught in class. She recalled the following lines from professor Gopi&#x2019;s class: &#x201C;&#x2026; today&#x2019;s first driver would be the template for any driver you write in Linux. Writing any specialised/advanced driver is just a matter of what gets filled into its constructor and destructor&#x2026;&#x201D;</p>
<p>With that, she took out the first driver&#x2019;s code, and pulled out various reference books, to start writing a character driver on her own. She also downloaded the <a href="http://lwn.net/Kernel/LDD3/" target="_blank">online book</a>, Linux Device Drivers by Jonathan Corbet, Alessandro Rubini, and Greg Kroah-Hartman. Here is the summary of what she learnt.</p>
<h2 id="ws-of-character-drivers">W&#x2019;s of character drivers</h2>
<p>We already know what drivers are, and why we need them. What is so special about character drivers? If we write drivers for byte-oriented operations (or, in C lingo, character-oriented operations), then we refer to them as character drivers. Since the majority of devices are byte-oriented, the majority of device drivers are character device drivers.</p>
<p>Take, for example, serial drivers, audio drivers, video drivers, camera drivers, and basic I/O drivers. In fact, all device drivers that are neither storage nor network device drivers are some type of a character driver. Let&#x2019;s look into the commonalities of these character drivers, and how Shweta wrote one of them.</p>
<p><img src="../Images/Part4/figure_7_character_driver_overview.png" alt="Figure 7"></p>
<h2 id="the-complete-connection">The complete connection</h2>
<p>As shown in Figure 1, for any user-space application to operate on a byte-oriented device (in hardware space), it should use the corresponding character device driver (in kernel space). Character driver usage is done through the corresponding character device file(s), linked to it through the virtual file system (VFS). What this means is that an application does the usual file operations on the character device file. Those operations are translated to the corresponding functions in the linked character device driver by the VFS. Those functions then do the final low-level access to the actual device to achieve the desired results.</p>
<p>Note that though the application does the usual file operations, their outcome may not be the usual ones. Rather, they would be as driven by the corresponding functions in the device driver. For example, a write followed by a read may not fetch what has just been written to the character device file, unlike for regular files. Remember that this is the usual expected behaviour for device files. Let&#x2019;s take an audio device file as an example. What we write into it is the audio data we want to play back, say through a speaker. However, the read would get us audio data that we are recording, say through a microphone. The recorded data need not be the played-back data.</p>
<p>In this complete connection from application to the device, there are four major entities involved:</p>
<ol>
<li>Application</li>
<li>Character device file</li>
<li>Character device driver</li>
<li>Character device</li>
</ol>
<p>And the interesting thing is that, all of these can exist independently on a system, without the other being there. So, mere existence of these on a system doesn&#x2019;t mean they are linked to form the complete connection. Rather, they need to be explicitly connected. Application gets connected to a device file by invoking open system call on the device file. Device file(s) are linked to the device driver by specific registrations by the driver. And the device driver is linked to a device by its device-specific low-level operations. Thus, forming the complete connection. With this, note that the character device file is not the actual device but just a placeholder for the actual device.</p>
<h2 id="major--minor-number">Major &amp; minor number</h2>
<p>Connection between the application and the device file is based on the name of the device file. However, the connection between the device file and the device driver is based on the number of the device file, not the name. This allows a user-space application to have any name for the device file, and enables the kernel-space to have trivial index-based linkage between the device file &amp; the device driver. This device file number is more commonly referred as the <code>&lt;major, minor&gt;</code> pair, or the major &amp; minor numbers of the device file. Earlier (till kernel 2.4), one major number was for one driver, and the minor number used to represent the sub-functionalities of the driver. With kernel 2.6, this distinction is no longer mandatory &#x2013; there could be multiple drivers under same major number but obviously with different minor number ranges. However, this is more common with the non-reserved major numbers and standard major numbers are typically preserved for single drivers. For example, 4 for serial interfaces, 13 for mice, 14 for audio devices, &#x2026;. The following command would list the various character device files on your system:</p>
<pre><code>$ ls -l /dev/ | grep &#x201C;^c&#x201D;
</code></pre><h2 id="major-minor-related-support-in-kernel-26"><code>&lt;major, minor&gt;</code> related support in kernel 2.6</h2>
<p>Type: (defined in kernel header <code>&lt;linux/types.h&gt;</code>)</p>
<pre><code>dev_t // contains both major &amp; minor numbers
</code></pre><p>Macros: (defined in kernel header <code>&lt;linux/kdev_t.h&gt;</code>)</p>
<pre><code class="lang-C">MAJOR(<span class="hljs-keyword">dev_t</span> dev) <span class="hljs-comment">// extracts the major number from dev</span>
MINOR(<span class="hljs-keyword">dev_t</span> dev) <span class="hljs-comment">// extracts the minor number from dev</span>
MKDEV(<span class="hljs-keyword">int</span> major, <span class="hljs-keyword">int</span> minor) <span class="hljs-comment">// creates the dev from major &amp; minor</span>
</code></pre>
<p>Connecting the device file with the device driver involves two steps:</p>
<ol>
<li>Registering for the <code>&lt;major, minor&gt;</code> range of device files.</li>
<li>Linking the device file operations to the device driver functions.</li>
</ol>
<p>First step is achieved using either of the following two APIs: (defined in kernel header <code>&lt;linux/fs.h&gt;</code>)</p>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">register_chrdev_region</span><span class="hljs-params">(dev_t first, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cnt, <span class="hljs-keyword">char</span> *name)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">alloc_chrdev_region</span><span class="hljs-params">(
    dev_t *first, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> firstminor, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cnt, <span class="hljs-keyword">char</span> *name)</span></span>;
</code></pre>
<p>First API registers the cnt number of device file numbers starting from first, with the name. Second API dynamically figures out a free major number and registers the cnt number of device file numbers starting from <code>&lt;the free major, firstminor&gt;</code>, with the name. In either case, the /proc/devices kernel window lists the name with the registered major number. With this information, Shweta added the following into the first driver code.</p>
<pre><code class="lang-C"><span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/types.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kdev_t.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span>

<span class="hljs-keyword">static</span> <span class="hljs-keyword">dev_t</span> first; <span class="hljs-comment">// Global variable for the first device number</span>
</code></pre>
<p>In the constructor, she added:</p>
<pre><code class="lang-C"><span class="hljs-keyword">int</span> ret;

<span class="hljs-keyword">if</span> ((ret = alloc_chrdev_region(&amp;first, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-string">&quot;Shweta&quot;</span>)) &lt; <span class="hljs-number">0</span>)
{
    <span class="hljs-keyword">return</span> ret;
}
printk(KERN_INFO <span class="hljs-string">&quot;&lt;Major, Minor&gt;: &lt;%d, %d&gt;\n&quot;</span>, MAJOR(first), MINOR(first));
</code></pre>
<p>In the destructor, she added:</p>
<pre><code>unregister_chrdev_region(first, 3);
</code></pre><p>Putting it all together, it becomes:</p>
<pre><code class="lang-C"><span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/version.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/types.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kdev_t.h&gt;</span></span>
<span class="hljs-preprocessor">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span>

<span class="hljs-keyword">static</span> <span class="hljs-keyword">dev_t</span> first; <span class="hljs-comment">// Global variable for the first device number</span>

<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> __<span class="hljs-function">init <span class="hljs-title">ofcd_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> <span class="hljs-comment">/* Constructor */</span>
</span>{
    <span class="hljs-keyword">int</span> ret;

    printk(KERN_INFO <span class="hljs-string">&quot;Namaskar: ofcd registered&quot;</span>);
    <span class="hljs-keyword">if</span> ((ret = alloc_chrdev_region(&amp;first, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-string">&quot;Shweta&quot;</span>)) &lt; <span class="hljs-number">0</span>)
    {
        <span class="hljs-keyword">return</span> ret;
    }
    printk(KERN_INFO <span class="hljs-string">&quot;&lt;Major, Minor&gt;: &lt;%d, %d&gt;\n&quot;</span>, MAJOR(first), MINOR(first));
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> __<span class="hljs-function"><span class="hljs-built_in">exit</span> <span class="hljs-title">ofcd_exit</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> <span class="hljs-comment">/* Destructor */</span>
</span>{
    unregister_chrdev_region(first, <span class="hljs-number">3</span>);
    printk(KERN_INFO <span class="hljs-string">&quot;Alvida: ofcd unregistered&quot;</span>);
}

module_init(ofcd_init);
module_exit(ofcd_exit);

MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);
MODULE_AUTHOR(<span class="hljs-string">&quot;Anil Kumar Pugalia &lt;email@sarika-pugs.com&gt;&quot;</span>);
MODULE_DESCRIPTION(<span class="hljs-string">&quot;Our First Character Driver&quot;</span>);
</code></pre>
<p>Then, Shweta repeated the usual steps, she learnt for the first driver</p>
<ul>
<li>Build the driver (.ko file) by typing <code>make</code></li>
<li>Load the driver using <code>insmod</code></li>
<li>List the loaded modules using <code>lsmod</code></li>
<li>Unload the driver using <code>rmmod</code></li>
</ul>
<h2 id="summing-up">Summing up</h2>
<p>Additionally, before unloading the driver, she peeped into the kernel window /proc/devices to look for the registered major number with the name &#x201C;Shweta&#x201D; using cat /proc/devices. It was right there. But she couldn&#x2019;t find any device file created under /dev with the same major number. So, she created them by hand using mknod, and then tried reading &amp; writing those. Figure 8 shows all these. Please note that the major number &#x201C;250&#x201D; may vary from system to system based on the availability. Figure 8 also shows the results, Shweta got from reading &amp; writing one of the device files. That reminded her that the second step for connecting the device file with the device driver &#x2013; &#x201C;Linking the device file operations to the device driver functions&#x201D; is not yet done. She realized that she needs to dig further information to complete this step and also to figure out the reason for the missing device files under /dev. We shall continue further in our next article, to figure out what more is Shweta learning and how is she going ahead with her first character driver.</p>
<p><img src="../Images/Part4/figure_8_char_dev_file_experiments.png" alt="Figure 8"></p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../Content/Part03.html" class="navigation navigation-prev " aria-label="Previous page: Kernel C Extras in a Linux Driver"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../Content/Part05.html" class="navigation navigation-next " aria-label="Next page: Character Device Files - Creation &amp; Operations"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
